function MessageFlow(a,k){function l(a,b,c,e,g,h){a.rect(b,c,e,g);b=f/2+b;e=d+c;a.text(b,d/2+c,h).attr({"text-anchor":"middle",fill:"#000","font-size":14});return a.path("M "+b+" "+e+" V "+(parseInt(a.height)-c)).attr({stroke:"#aaa"})}var b;if("object"===typeof a)b=a;else if("string"===typeof a)b=document.getElementById(a);else return;b.innerHTML="";var d=48,f=80;this.margin=20;this.paper=Raphael(b,parseInt(b.style.width),parseInt(b.style.height));this.nodePathArray=[];this.messages=[];this.lastMessageYOffset=
4*this.margin+d;var e=[];if(1==k.length)e.push(this.paper.width/2-f/2);else if(2==k.length)e.push(this.margin),e.push(this.paper.width-f-this.margin);else if(2<k.length){e.push(this.margin);var c=k.length-2,g=this.paper.width-2*this.margin-2*f;if(c*(f+this.margin)+this.margin<g){b=Math.round((g-f*c)/(c+1));for(var g=this.margin,h=0;h<c;h++)g+=f+b,e.push(g)}else b.innerHTML="Message Flow diagram unavailable. Too many column nodes.";e.push(this.paper.width-f-this.margin)}for(c=0;c<k.length;c++)this.nodePathArray.push(l(this.paper,
e[c],this.margin,f,d,k[c]))}
MessageFlow.prototype.addMessageLine=function(a){function k(b,c,e,f,d){this.line=b;this.arrow=c;this.primaryText=e;this.secondaryText=f;this.clicked=!1;this.callback=a.callback;this.callbackData=a.callbackData;this.primaryText.data("message",this);null!=this.primaryText&&(this.primaryText.attr({cursor:"pointer"}),this.primaryText.click(function(a){for(a=0;a<d.length;a++)d[a].clicked=!1,d[a].primaryText.attr({fill:"black"}),d[a].secondaryText.attr({fill:"#666"}),d[a].line.attr({stroke:"black"}),d[a].arrow.attr({stroke:"black"});
this.attr({fill:"blue"});f.attr({fill:"blue"});b.attr({stroke:"blue"});c.attr({stroke:"blue"});"undefined"!==typeof this.data("message").callback&&("undefined"!==typeof this.data("message").callbackData&&null!=this.data("message").callbackData)&&(a=this.data("message").callback,a(this.data("message").callbackData));this.data("message").clicked=!0}),this.primaryText.mouseover(function(){this.attr({fill:"blue"})}),this.primaryText.mouseout(function(){this.data("message").clicked||this.attr({fill:"black"})}))}
if("undefined"!==typeof this.nodePathArray&&!(0>a.from||a.from>this.nodePathArray.length||0>a.to||a.to>this.nodePathArray.length||a.from==a.to)){var l=3*this.margin,b=this.nodePathArray[0].attr("path")[1][1]-this.nodePathArray[0].attr("path")[0][2],d=b-this.messages.length*l;if(d<2*l){d=2*l-d;this.paper.setSize(this.paper.width,this.paper.height+d);/msie/.test(navigator.userAgent.toLowerCase())?this.paper.canvas.parentNode.style.height=parseInt(this.paper.canvas.parentNode.style.height)+d+"px":this.paper.canvas.parentElement.style.height=
parseInt(this.paper.canvas.parentElement.style.height)+d+"px";for(var f=0;f<this.nodePathArray.length;f++){var e=this.nodePathArray[f];e.attr({path:"M "+e.attr("path")[0][1]+","+e.attr("path")[0][2]+" V "+(e.attr("path")[1][1]+d)});b+=d}}var b=this.nodePathArray[a.from-1].attr("path")[0][1],c=this.nodePathArray[a.to-1].attr("path")[0][1],d=this.paper.path("M "+b+", "+this.lastMessageYOffset+" H "+c),f="start",e=8,g=c+" "+this.lastMessageYOffset,h=c+6,m=h+" "+(this.lastMessageYOffset-6),h=h+" "+(this.lastMessageYOffset+
6),n=c+" "+this.lastMessageYOffset;a.from<a.to?(h=c-6,m=h+" "+(this.lastMessageYOffset-6),h=h+" "+(this.lastMessageYOffset+6)):(f="end",e=-8);c=this.paper.path("M "+g+" L"+m+" L"+h+" L"+n).attr("fill","black");g=null;"undefined"!=typeof a.primaryText&&null!=a.primaryText&&(g=this.paper.text(b+e,this.lastMessageYOffset-12,a.primaryText).attr({"text-anchor":f,fill:"#000","font-size":13,"font-style":"bold"}));m=null;"undefined"!=typeof a.secondaryText&&null!=a.secondaryText&&(m=this.paper.text(b+e,this.lastMessageYOffset+
10,a.secondaryText).attr({"text-anchor":f,fill:"#666","font-size":12}));b=new k(d,c,g,m,this.messages);this.messages.push(b);this.lastMessageYOffset+=l;return b}};
